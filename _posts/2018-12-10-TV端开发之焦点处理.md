---
layout:     post
title:      TVç«¯å¼€å‘ä¹‹ç„¦ç‚¹å¤„ç†
subtitle:   Android TVç«¯å¼€å‘ä»0åˆ°1çš„ä¸€ç‚¹ç»éªŒ
date:       2018-12-10
author:     lx8421bcd
header-img: img/post-bg-debug.png
catalog: true
tags:
    - Android
    - Android TVç«¯
---

## å‰è¨€
å…³äºä»€ä¹ˆfocusæœºåˆ¶ç”¨æ¥å¹²ä»€ä¹ˆè¿™äº›å£æ°´è¯å°±ä¸è¯´äº†ï¼Œç®€è¦ä¸€å¥è¯å°±æ˜¯focusæœºåˆ¶æ˜¯Androidç”¨äºå¤„ç†é”®ç›˜äº¤äº’çš„ï¼Œç„¦ç‚¹å†³å®šå“ªä¸ªæ§ä»¶å¤„ç†æŒ‰é”®äº‹ä»¶ã€‚åœ¨TVç«¯å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸ç”¨å†å…³å¿ƒå„ç§å„æ ·çš„è§¦æ§å†²çªï¼Œå–è€Œä»£ä¹‹å„ç§è«åå…¶å¦™çš„ç„¦ç‚¹è·³è½¬é—®é¢˜ï¼Œè¦å˜æ¸…è¿™äº›ç¥å¥‡çš„ç„¦ç‚¹è·³è½¬ï¼Œå¹¶ä¿®å¤å®ƒä»¬ï¼Œå¿…é¡»äº†è§£Androidç„¦ç‚¹å¤„ç†å’Œæ´¾å‘æœºåˆ¶ã€‚æ­¤æ–‡ä½œä¸ºå­¦ä¹ æ•´ç†å’Œç»éªŒæ€»ç»“ï¼Œå‡ºäºç¯‡å¹…è€ƒè™‘ä»¥åŠä¾§é‡ç‚¹ä¸åŒï¼Œæœ¬æ–‡ä¸è®¨è®ºè§¦æ‘¸æ¨¡å¼(TouchMode)ä¸‹çš„ç„¦ç‚¹å¤„ç†ã€‚


## å‡ ä¸ªå…³äºç„¦ç‚¹çš„çŸ¥è¯†ç‚¹

#### ç„¦ç‚¹æ•°é‡
ç•Œé¢ä¸Šçš„ç„¦ç‚¹æ•°æ°¸è¿œå°äºç­‰äº1ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»ä½•æ—¶å€™å¤šæœ€å¤šåªä¼šæœ‰ä¸€ä¸ªç„¦ç‚¹ï¼Œæˆ–è€…ç”±äºç„¦ç‚¹ä¸¢å¤±ç­‰å› ç´ ç•Œé¢ä¸Šæ²¡æœ‰ç„¦ç‚¹ã€‚

#### æ‰‹åŠ¨ç”³è¯·ç„¦ç‚¹
éœ€è¦æ‰‹åŠ¨è¯·æ±‚ç„¦ç‚¹æ—¶ï¼Œè°ƒç”¨requestFocus(), åœ¨XMLçš„Viewé…ç½®ä¸­æ·»åŠ ```<requestFocus/>```æ ‡ç­¾å¯ä»¥è®©Viewåœ¨åˆå§‹åŒ–æ—¶è¯·æ±‚ç„¦ç‚¹ï¼Œä¸è¿‡ä¸å»ºè®®è¿™ä¹ˆåšï¼Œç„¦ç‚¹çš„ç”³è¯·æœ€å¥½ç»Ÿä¸€ç®¡ç†ã€‚

#### Viewèƒ½å¦è·å–ç„¦ç‚¹
å¹¶ä¸æ˜¯æ‰€æœ‰Viewéƒ½é»˜è®¤èƒ½è·å–ç„¦ç‚¹ï¼Œç‰¹åˆ«æ˜¯éšç³»ç»Ÿç‰ˆæœ¬ä¸åŒï¼ŒViewé»˜è®¤èƒ½å¦è·å–ç„¦ç‚¹ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥æœ€å¥½çš„åšæ³•æ˜¯å¯¹äºèƒ½è·å–ç„¦ç‚¹çš„Viewï¼Œåœ¨å®šä¹‰æ—¶è®¾ç½®```android:focusable:"true"```æˆ–```setFocusable(true)```ã€‚

#### ViewGroupä¸ç„¦ç‚¹
ç„¦ç‚¹å¹¶æ²¡æœ‰å±‚çº§åˆ¶çº¦å…³ç³»ï¼Œä¸€ä¸ªViewGroupæ²¡æœ‰ç„¦ç‚¹å¹¶ä¸ä»£è¡¨å…¶ChildViewæ²¡æœ‰ç„¦ç‚¹ã€‚  

ViewGroupä¸­æœ‰ä¸€ä¸ªmFocusedå˜é‡ç”¨äºå­˜å‚¨å…¶æ‹¥æœ‰ç„¦ç‚¹çš„childï¼Œæ³¨æ„è¿™é‡Œå¹¶ä¸ä»…ä»…æ˜¯åªå­˜å‚¨focused viewï¼Œæ‹¥æœ‰focused viewçš„ViewGroupä¹Ÿä¼šè¢«å­˜å‚¨äºmFocusedï¼Œç®€è€Œè¨€ä¹‹æˆ‘ä»¬èƒ½å¤Ÿä»ViewGroupæä¾›çš„æ–¹æ³•ä¸­å¾—çŸ¥å…¶å†…éƒ¨æ˜¯å¦åŒ…å«focused viewã€‚  
```findFocus()```æ–¹æ³•å°±æ˜¯ç”¨äºé€’å½’æŸ¥æ‰¾è·å–ViewGroupå†…éƒ¨çš„focused viewï¼Œå¦‚æœViewGroupå†…éƒ¨æ²¡æœ‰focusï¼Œåˆ™è¿”å›nullã€‚è€Œ```getFocusedChild()```æ–¹æ³•åˆ™ç›´æ¥è¿”å›mFocusedï¼Œæ³¨æ„è¿™é‡Œçš„ä¸åŒã€‚

```setDescendantFocusability()``` æ–¹æ³•å¯ä»¥ç”¨äºæŒ‡å®šViewGroupçš„ç„¦ç‚¹è·å–ç­–ç•¥ï¼Œæœ‰ä»¥ä¸‹ä¸‰ä¸ªå€¼ï¼š
* ```FOCUS_BLOCK_DESCENDANTS``` - é˜»æ­¢childè·å–ç„¦ç‚¹ï¼Œå³ä½¿childè°ƒç”¨äº†rquestFocus()ä¹Ÿæ‹¿ä¸åˆ°ç„¦ç‚¹
* ```FOCUS_BEFORE_DESCENDANTS``` - è‡ªå·±ä¼˜å…ˆæ‹¿ç„¦ç‚¹
* ```FOCUS_AFTER_DESCENDANTS``` - é»˜è®¤ç­–ç•¥ï¼Œchildå…ˆæ‹¿ç„¦ç‚¹ï¼Œchildæ‹¿ä¸äº†äº†è‡ªå·±å†æ‹¿

#### has & is
```hasFocus()``` æ–¹æ³•åªè¦ViewGroupæœ¬èº«æœ‰ç„¦ç‚¹æˆ–å…¶childæœ‰ç„¦ç‚¹éƒ½è¿”å›trueï¼Œè€Œ ```isFocused()``` åªæœ‰ViwGroupè‡ªèº«æœ‰ç„¦ç‚¹æ‰è¿”å›trueã€‚åŒç†è¿˜æœ‰ ```isFocusable()``` å’Œ ```hasFocusable()``` ï¼Œâ€œisâ€åˆ¤æ–­è‡ªèº«ï¼Œâ€œhasâ€åˆ¤æ–­è‡ªèº«å’Œchildã€‚


## ç„¦ç‚¹æŸ¥æ‰¾æœºåˆ¶
æ—¢ç„¶ä¸è€ƒè™‘è§¦æ§å±ï¼Œé‚£ä¹ˆç„¦ç‚¹çš„ç§»åŠ¨å°±ä¸æŒ‰é”®æ¯æ¯ç›¸å…³ï¼Œåœ¨äº†è§£ç„¦ç‚¹æŸ¥æ‰¾æœºåˆ¶æ—¶å¿…é¡»ä¸æŒ‰é”®å¤„ç†ç»“åˆèµ·æ¥ã€‚å…³äºä»æŒ‰é”®æŒ‰ä¸‹åˆ°äº‹ä»¶ä¼ é€’åˆ°UIå±‚çš„ä¸€ç³»åˆ—æœºåˆ¶å°±ä¸æ·±ç©¶äº†ï¼Œç›´æ¥å°†åˆ†æçš„èµ·ç‚¹å®šä½äº ```ViewRootImpl```  
[ViewRootImpl.java - googlesource](https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/view/ViewRootImpl.java)

ç ”ç©¶ä¸€ä¸‹ViewRootImplä¸­å®šä¹‰çš„å†…éƒ¨ç±»```ViewPostImeInputStage```ï¼ŒæŒ‰é”®äº‹ä»¶(KeyEvent)å°†ä¼šç”±```processKeyEvent()```æ–¹æ³•å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å…³é”®æ–¹æ³•ã€‚
```java
final class ViewPostImeInputStage extends InputStage {

    ......

    @Override
    protected int onProcess(QueuedInputEvent q) {
        if (q.mEvent instanceof KeyEvent) {
            return processKeyEvent(q); // æŒ‰é”®äº‹ä»¶äº¤ç”±processKeyEvent()æ–¹æ³•å¤„ç†
        } else {
            final int source = q.mEvent.getSource();
            if ((source & InputDevice.SOURCE_CLASS_POINTER) != 0) {
                return processPointerEvent(q);
            } else if ((source & InputDevice.SOURCE_CLASS_TRACKBALL) != 0) {
                return processTrackballEvent(q);
            } else {
                return processGenericMotionEvent(q);
            }
        }
    }
    private int processKeyEvent(QueuedInputEvent q) {
        final KeyEvent event = (KeyEvent)q.mEvent;
        if (mUnhandledKeyManager.preViewDispatch(event)) {
            return FINISH_HANDLED;
        }
        // å°†KeyEventæ´¾å‘åˆ°å¸ƒå±€æ ‘ä¸Šçœ‹çœ‹æœ‰æ²¡æœ‰Viewæ¶ˆè€—ï¼Œå¦‚æœè¢«æ¶ˆè€—ï¼Œè¿”å›FINISH_HANDLED
        if (mView.dispatchKeyEvent(event)) {
            return FINISH_HANDLED;
        }

        ......

        // é»˜è®¤æƒ…å†µä¸‹çš„ç„¦ç‚¹å¤„ç†
        // Handle automatic focus changes.
        if (event.getAction() == KeyEvent.ACTION_DOWN) {
            if (groupNavigationDirection != 0) {
                if (performKeyboardGroupNavigation(groupNavigationDirection)) {
                    return FINISH_HANDLED;
                }
            } else {
                if (performFocusNavigation(event)) {
                    return FINISH_HANDLED;
                }
            }
        }
        return FORWARD;
    }
    ......
}
```
#### æŒ‰é”®ä¸direction
åœ¨ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°é»˜è®¤çš„ç„¦ç‚¹å¤„ç†è°ƒç”¨äº†```performKeyboardGroupNavigation()```å’Œ```performFocusNavigation()```ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å¤„ç†åœ¨äº```performFocusNavigation()```æ–¹æ³•
```java
private boolean performFocusNavigation(KeyEvent event) {
    int direction = 0;
    //direction åˆ¤æ–­
    switch (event.getKeyCode()) {
        case KeyEvent.KEYCODE_DPAD_LEFT:
            if (event.hasNoModifiers()) {
                direction = View.FOCUS_LEFT;
            }
            break;
        case KeyEvent.KEYCODE_DPAD_RIGHT:
            if (event.hasNoModifiers()) {
                direction = View.FOCUS_RIGHT;
            }
            break;
        case KeyEvent.KEYCODE_DPAD_UP:
            if (event.hasNoModifiers()) {
                direction = View.FOCUS_UP;
            }
            break;
        case KeyEvent.KEYCODE_DPAD_DOWN:
            if (event.hasNoModifiers()) {
                direction = View.FOCUS_DOWN;
            }
            break;
        case KeyEvent.KEYCODE_TAB:
            if (event.hasNoModifiers()) {
                direction = View.FOCUS_FORWARD;
            } else if (event.hasModifiers(KeyEvent.META_SHIFT_ON)) {
                direction = View.FOCUS_BACKWARD;
            }
            break;
    }
    if (direction != 0) {
        View focused = mView.findFocus();
        if (focused != null) {
            View v = focused.focusSearch(direction);
            if (v != null && v != focused) {
                // do the math the get the interesting rect
                // of previous focused into the coord system of
                // newly focused view
                focused.getFocusedRect(mTempRect);
                if (mView instanceof ViewGroup) {
                    ((ViewGroup) mView).offsetDescendantRectToMyCoords(
                            focused, mTempRect);
                    ((ViewGroup) mView).offsetRectIntoDescendantCoords(
                            v, mTempRect);
                }
                if (v.requestFocus(direction, mTempRect)) {
                    playSoundEffect(SoundEffectConstants
                            .getContantForFocusDirection(direction));
                    return true;
                }
            }
            // Give the focused view a last chance to handle the dpad key.
            if (mView.dispatchUnhandledMove(focused, direction)) {
                return true;
            }
        } else {
            if (mView.restoreDefaultFocus()) {
                return true;
            }
        }
    }
    return false;
}
```
__directionå€¼è¡¨ç¤ºäº†é”®ç›˜çš„æŒ‰é”®æ–¹å‘ï¼Œåªæœ‰ä¸Šã€ä¸‹ã€å·¦ã€å³å››ä¸ªæšä¸¾å€¼__ã€‚å¹³æ—¶é¥æ§å™¨ä¹Ÿä¸å­˜åœ¨tabå’Œshiftï¼Œè¿™ä¸¤ä¸ªå¯ä»¥ä¸ç”¨ç®¡ï¼Œåˆ¤æ–­å®Œdirectionåèµ°åˆ°ç„¦ç‚¹å¤„ç†ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯KeyEventçš„directionå’ŒViewçš„focus directionæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ‰éœ€è¦ç”¨ä¸€ä¸ªswitchè¯­å¥è½¬æ¢ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ç„¦ç‚¹ä¼ é€’çš„å‡ ä¸ªå…³é”®æ–¹æ³•äº†ï¼Œå…¶ä¸­æˆ‘ä»¬æœ€éœ€è¦å…³æ³¨çš„æ˜¯Viewçš„```focusSearch()```æ–¹æ³•ã€‚

#### focusSearch() 
Viewçš„```focusSearch()```æ–¹æ³•å†…å®¹æ¯”è¾ƒç®€å•ï¼Œè¯·æ±‚å®ƒä¸Šä¸€å±‚çš„```focusSearch()```ï¼ŒåµŒå¥—è°ƒç”¨æŸ¥ç„¦ç‚¹ï¼ŒæŸ¥ä¸åˆ°å°±è¿”å›nullã€‚  
[View.java - googlesource](https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/view/View.java) 
```java
    public View focusSearch(@FocusRealDirection int direction) {
        if (mParent != null) {
            return mParent.focusSearch(this, direction);
        } else {
            return null;
        }
    }
```  
mParentæ˜¯ViewParentæ¥å£çš„å®ä¾‹ï¼Œåœ¨è¿™é‡Œå¯ä»¥è®¤ä¸ºæ˜¯ViewGroupï¼Œæ‰€ä»¥æ¥çœ‹ä¸‹ViewGroupçš„```focusSearch()```ã€‚  
[ViewGroup.java - googlesource](https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/view/ViewGroup.java)  
```java
    @Override
    public View focusSearch(View focused, int direction) {
        if (isRootNamespace()) {
            // root namespace means we should consider ourselves the top of the
            // tree for focus searching; otherwise we could be focus searching
            // into other tabs.  see LocalActivityManager and TabHost for more info.
            return FocusFinder.getInstance().findNextFocus(this, focused, direction);
        } else if (mParent != null) {
            return mParent.focusSearch(focused, direction);
        }
        return null;
    }
```
å¯ä»¥çœ‹åˆ°ä»ç„¶æ˜¯ä¸ªé€çº§ä¸ŠæŸ¥çš„é€»è¾‘ï¼Œåªä¸è¿‡å¤šäº†ä¸€ç‚¹ï¼Œå½“ViewGroupæ˜¯æ ¹å¸ƒå±€æ—¶ï¼Œå°†ä¼šè°ƒç”¨FocusFinderå»æŸ¥æ‰¾ç„¦ç‚¹ã€‚

#### FocusFinder
FocusFinderæ˜¯ä¸€ä¸ªå…¨å±€å•ä¾‹ï¼Œé€šè¿‡ä¹‹å‰çš„ä»£ç æˆ‘ä»¬å¯ä»¥ç¡®å®šç»å¤§éƒ¨åˆ†é»˜è®¤çš„ç„¦ç‚¹æŸ¥æ‰¾æœ€åéƒ½ä¼šäº¤ç”±FocusFinderæ¥å¤„ç†ã€‚  
[FocusFinder.java - googlesource](https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/view/FocusFinder.java)  
è°ƒç”¨```FocusFinder.findeNextFocus()```æœ€åä¼šæ‰§è¡Œåˆ°è¿™ä¸ªæ–¹æ³•ï¼š
```java
private View findNextFocus(ViewGroup root, View focused, Rect focusedRect, int direction) {
    View next = null;
    ViewGroup effectiveRoot = getEffectiveRoot(root, focused);
    if (focused != null) {
        next = findNextUserSpecifiedFocus(effectiveRoot, focused, direction);
    }
    if (next != null) {
        return next;
    }
    ArrayList<View> focusables = mTempList;
    try {
        focusables.clear();
        effectiveRoot.addFocusables(focusables, direction);
        if (!focusables.isEmpty()) {
            next = findNextFocus(effectiveRoot, focused, focusedRect, direction, focusables);
        }
    } finally {
        focusables.clear();
    }
    return next;
}
```
ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°FocusFinderå°†ä¼šä¼˜å…ˆæŸ¥æ‰¾æœ‰æ²¡æœ‰ç‰¹å®šIDçš„Viewï¼Œä¹Ÿå°±æ˜¯XMLä¸­çš„```android:NextFocusUp="..."```ä¹‹ç±»çš„æ ‡è¯†ã€‚  
å¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°ç‰¹æ®ŠIDçš„Viewï¼Œåˆ™å°†ä¼šè¿›å…¥ä¸‹ä¸€ä¸ª```finNextFocus()```
```java
private View findNextFocus(ViewGroup root, View focused, Rect focusedRect,
        int direction, ArrayList<View> focusables) {
    if (focused != null) {
        if (focusedRect == null) {
            focusedRect = mFocusedRect;
        }
        // fill in interesting rect from focused
        focused.getFocusedRect(focusedRect);
        root.offsetDescendantRectToMyCoords(focused, focusedRect);
    } else {
        if (focusedRect == null) {
            focusedRect = mFocusedRect;
            // make up a rect at top left or bottom right of root
            switch (direction) {
                case View.FOCUS_RIGHT:
                case View.FOCUS_DOWN:
                    setFocusTopLeft(root, focusedRect);
                    break;
                case View.FOCUS_FORWARD:
                    if (root.isLayoutRtl()) {
                        setFocusBottomRight(root, focusedRect);
                    } else {
                        setFocusTopLeft(root, focusedRect);
                    }
                    break;
                case View.FOCUS_LEFT:
                case View.FOCUS_UP:
                    setFocusBottomRight(root, focusedRect);
                    break;
                case View.FOCUS_BACKWARD:
                    if (root.isLayoutRtl()) {
                        setFocusTopLeft(root, focusedRect);
                    } else {
                        setFocusBottomRight(root, focusedRect);
                    break;
                }
            }
        }
    }
    switch (direction) {
        case View.FOCUS_FORWARD:
        case View.FOCUS_BACKWARD:
            return findNextFocusInRelativeDirection(focusables, root, focused, focusedRect,
                    direction);
        case View.FOCUS_UP:
        case View.FOCUS_DOWN:
        case View.FOCUS_LEFT:
        case View.FOCUS_RIGHT:
            return findNextFocusInAbsoluteDirection(focusables, root, focused,
                    focusedRect, direction);
        default:
            throw new IllegalArgumentException("Unknown direction: " + direction);
    }
}
```
è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦å†…å®¹å¯ä»¥æ¦‚æ‹¬ä¸ºæ ¹æ®ä¼ å…¥çš„ç„¦ç‚¹ã€æ–¹å‘ã€å¯è·å–ç„¦ç‚¹çš„æ§ä»¶åˆ—è¡¨ç­‰å‚æ•°ï¼Œé€šè¿‡åæ ‡è¿ç®—è®¡ç®—å‡ºæŒ‡å®šæ–¹å‘ä¸Šçš„ä¸‹ä¸€ä¸ªç„¦ç‚¹ã€‚

#### ç»“è®º
é€šè¿‡ä»¥ä¸Šçš„ç ”ç©¶å¯ä»¥æ¦‚æ‹¬å‡ºå‡ ç‚¹ï¼š
1. å½“æŒ‰é”®äº‹ä»¶è§¦å‘ç„¦ç‚¹æŸ¥æ‰¾æµç¨‹æ—¶ï¼Œå§‹äºViewRootImplè°ƒç”¨```processKeyEvent()```æ–¹æ³•å†…é»˜è®¤çš„ç„¦ç‚¹å¤„ç†ï¼Œå¦‚æœæœ‰ç„¦ç‚¹åˆ™è°ƒç”¨å½“å‰ç„¦ç‚¹viewçš„```focusSearch()```æ–¹æ³•,å¦‚æœå½“å‰é¡µé¢æ²¡æœ‰ç„¦ç‚¹ï¼Œå°†ä¼šè°ƒç”¨æ ¹å¸ƒå±€çš„```restoreDefaultFocus()```æ–¹æ³•ã€‚
2. ä¸Touchäº‹ä»¶çš„ä¼ é€’ä¸åŒï¼Œç„¦ç‚¹æŸ¥æ‰¾æµç¨‹å¼€å§‹äºå½“å‰ç„¦ç‚¹Viewï¼Œé€çº§è¯·æ±‚çˆ¶å¸ƒå±€çš„```focusSearch()```æ–¹æ³•ï¼Œå¦‚æ— å…¶å®ƒæƒ…å†µå°†ä¼šä¸€ç›´è¯·æ±‚åˆ°æ ¹å¸ƒå±€çš„```focusSearch()```æ–¹æ³•ï¼Œç„¶åè°ƒç”¨FocusFinderå¾—åˆ°ä¸‹ä¸€ä¸ªç„¦ç‚¹Viewï¼Œæ˜¯ä¸€ä¸ªç”±å†…åˆ°å¤–çš„è¿‡ç¨‹ã€‚
3. æ•´ä¸ªç„¦ç‚¹æŸ¥æ‰¾æµç¨‹å‡åœ¨```focusSearch()```æ–¹æ³•çš„åµŒå¥—è°ƒç”¨ä¸­å®Œæˆï¼Œå½“focusSearch()æ‰§è¡Œå®Œæ¯•è¿”å›ç»“æœåï¼Œä¸‹ä¸€ç„¦ç‚¹Viewå°±å·²ç»ç¡®å®šã€‚


## å¦‚ä½•æŒ‡å®šç„¦ç‚¹æ´¾å‘
äº†è§£è¿‡ç„¦ç‚¹æŸ¥æ‰¾æµç¨‹ï¼Œå°±å¯ä»¥å»æ‰¾ä¸¤ä¸ªåˆ‡å…¥ç‚¹ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨ä¸Šé¢è¿™äº›æµç¨‹ä¸­ï¼Œæ‰¾åˆ°å¯ä»¥ç»§æ‰¿ã€é‡è½½çš„å†…å®¹ï¼Œåœ¨æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸­åšå‡ºæ‹¦æˆªï¼Œè¿”å›æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚

#### dispatchKeyEvent()
åœ¨ViewRootImplè°ƒç”¨```processKeyEvent()```æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŒ‰é”®äº‹ä»¶æ˜¯ä¼˜å…ˆäº¤ç”±æ ¹å¸ƒå±€çš„```dispatchKeyEvent()```æ–¹æ³•å¤„ç†çš„ï¼Œå¦‚æœè¿™ä¸ªäº‹ä»¶è¢«æ¶ˆè´¹ï¼Œé‚£åé¢ä¹Ÿå°±æ²¡æœ‰ç„¦ç‚¹æŸ¥æ‰¾ä»€ä¹ˆäº‹äº†ã€‚  
ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨```dispatchKeyEvent()```æ–¹æ³•ä¸­ï¼Œæ ¹æ®å…¥å‚åˆ¤æ–­æˆ‘ä»¬è¦çš„ç‰¹æ®Šç„¦ç‚¹æ˜¯å“ªä¸ªï¼Œç„¶årequestFocuså°±è¡Œäº†ã€‚å¹¶ä¸éœ€è¦èµ°ä¸€é“ç„¦ç‚¹æŸ¥æ‰¾æµç¨‹ã€‚

#### focusSearch()
æˆ‘ä»¬çŸ¥é“æ•´ä¸ªæŸ¥æ‰¾æµç¨‹æ˜¯åœ¨focusSearch()çš„é€çº§åµŒå¥—è°ƒç”¨ä¸­èµ°å®Œçš„ï¼Œæ—¢ç„¶æ˜¯é€çº§å‘ä¸Šè¯·æ±‚æŸ¥æ‰¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å¤–å±‚ViewGroupçš„```focusSearch()```æ–¹æ³•ä¸­ä½œå‡ºæ‹¦æˆªå³å¯ã€‚äº‹å®ä¸ŠGoogleä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ï¼Œåœ¨Googleçš„android-support-v17-leanbackåº“ä¸­ï¼ŒBrowseFrameLayoutæ§ä»¶å°±æ˜¯åœ¨å†…éƒ¨å®šä¹‰äº†Listenerå¹¶åœ¨focusSearché˜¶æ®µè°ƒç”¨Listenerè®©å¤–éƒ¨è¿”å›æŒ‡å®šçš„focusã€‚

[BrowseFrameLayout.java - googlesource](https://android.googlesource.com/platform/frameworks/support/+/bd4cbab/v17/leanback/src/android/support/v17/leanback/widget/BrowseFrameLayout.java?)  

å½“æˆ‘ä»¬éœ€è¦åœ¨å¤–å±‚æŒ‡å®šç„¦ç‚¹æ—¶ï¼Œå¯ä»¥å‚è€ƒBrowseFrameLayoutçš„æ–¹å¼å†™å‡ºè‡ªå®šä¹‰ViewGroupè¿›è¡Œç„¦ç‚¹æŸ¥æ‰¾æ‹¦æˆªã€‚


## ä¸€äº›å‘

#### æŸäº›è‡ªå®šä¹‰æ§ä»¶å†…éƒ¨è°ƒç”¨äº†requestFocus()
å½“ä½ çš„ç•Œé¢èµ°ç€èµ°ç€å‘ç°ç„¦ç‚¹ä¸çŸ¥é“é£åˆ°å“ªé‡Œå»ï¼Œè‡ªå·±åˆæ‰¾ä¸åˆ°åŸå› æ—¶ï¼Œå°±è¯¥è€ƒè™‘æœ‰æ²¡æœ‰è¿™æ–¹é¢çš„é—®é¢˜å­˜åœ¨äº†ï¼ŒAndroidæ‰‹æœºå¼€å‘ä¸ºä¸»çš„ä¹ æƒ¯è®©å¾ˆå¤šSDKå¼€å‘è€…æ¯”è¾ƒæ¼ è§†ç„¦ç‚¹çš„å­˜åœ¨ï¼Œä¸ºäº†å®ç°æŸäº›æ•ˆæœç›´æ¥åœ¨å…¶Viewåˆå§‹åŒ–æ—¶requestFocusï¼Œè¿™äº›åŸ‹åœ¨SDKä»£ç é‡Œçš„requestFocusæˆ‘ä»¬ä¸å®¹æ˜“æœç´¢åˆ°ï¼Œä½†æ˜¯ä¸€æ—¦å‡ºç°Viewé¢„åŠ è½½ï¼ˆæ¯”å¦‚ViewPageræ»‘åŠ¨ï¼‰ç­‰æƒ…å†µæ—¶ï¼Œè¿™äº›requestFocuså°±å°†ä¼šæˆä¸ºå¯¼è‡´ç„¦ç‚¹ä¹±é£çš„å…ƒå‡¶ï¼Œè€Œä¸”å¾ˆéš¾å¤„ç†ã€‚

å¯¹äºå†…éƒ¨åŒ…å«requestFocusçš„SDKæ§ä»¶ï¼Œæˆ‘ä»¬èƒ½åšçš„åªæœ‰åç¼–è¯‘å…¶æºç copyä¸€ä»½å‡ºæ¥ï¼Œæ³¨é‡Šæ‰requestFocusï¼Œå¦‚æœè¿™ä¸€æ­¥å¾ˆéš¾åšåˆ°çš„è¯ï¼Œåªæœ‰æ‰¾SDKæä¾›æ–¹æ€¼ä¸€é¡¿äº†ã€‚ğŸ˜„

#### æŒ‰é”®é•¿æŒ‰é£ç„¦ç‚¹
æ­¤é—®é¢˜ä¸»è¦å‘ç”ŸäºRecyclerViewçš„ä½¿ç”¨ä¸­ï¼Œç›®å‰æ¯”è¾ƒé€šè¡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯é™åˆ¶æŒ‰é”®é¢‘ç‡
[RecyclerViewåœ¨TVç«¯çš„ä½¿ç”¨](https://lx8421bcd.github.io/2018/12/09/TV%E7%AB%AF%E5%BC%80%E5%8F%91%E4%B9%8BRecyclerView/)




